<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Guru - Petualangan Kerajaan Angka</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-purple-900 via-indigo-900 to-gray-900 text-white min-h-screen">
  
  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <header class="mb-8 flex justify-between items-center">
      <div>
        <h1 class="text-4xl font-bold mb-2">ğŸ“Š Dashboard Guru</h1>
        <p class="text-gray-300">Pantau hasil belajar siswa secara real-time</p>
      </div>
      <div class="text-right">
        <p class="text-gray-400">Login sebagai: <span class="text-yellow-400 font-bold" id="username-display">Guru</span></p>
        <button onclick="logout()" class="text-sm text-red-400 hover:text-red-300 mt-1">ğŸšª Logout</button>
      </div>
    </header>

    <!-- Filter -->
    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input type="text" id="filter-name" placeholder="ğŸ” Cari nama siswa..." 
               class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-400">
        
        <select id="filter-skill" class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none">
          <option value="">Semua Jurus</option>
          <option value="add">âš”ï¸ Penggabungan</option>
          <option value="sub">ğŸ›¡ï¸ Pengurangan</option>
        </select>
        
        <select id="filter-mission" class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none">
          <option value="">Semua Misi</option>
          <option value="pribadi">Zona Aku Hebat</option>
          <option value="sosial">Misi Tim Hebat</option>
          <option value="saintifik">Misi Ilmuwan Cilik</option>
        </select>
        
        <button onclick="loadSubmissions()" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 rounded-lg font-bold text-gray-900">
          ğŸ”„ Refresh Data
        </button>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
      <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl p-6">
        <div class="text-5xl mb-2">ğŸ‘¨â€ğŸ“</div>
        <div class="text-3xl font-bold" id="stat-total">0</div>
        <div class="text-blue-100">Total Siswa</div>
      </div>
      
      <div class="bg-gradient-to-br from-green-500 to-green-700 rounded-2xl p-6">
        <div class="text-5xl mb-2">âœ…</div>
        <div class="text-3xl font-bold" id="stat-avg-correct">0</div>
        <div class="text-green-100">Rata-rata Benar</div>
      </div>
      
      <div class="bg-gradient-to-br from-yellow-500 to-yellow-700 rounded-2xl p-6">
        <div class="text-5xl mb-2">ğŸ’</div>
        <div class="text-3xl font-bold" id="stat-avg-points">0</div>
        <div class="text-yellow-100">Rata-rata Poin</div>
      </div>
      
      <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl p-6">
        <div class="text-5xl mb-2">ğŸ“ˆ</div>
        <div class="text-3xl font-bold" id="stat-avg-percentage">0%</div>
        <div class="text-purple-100">Rata-rata Nilai</div>
      </div>
    </div>

    <!-- Submissions List -->
    <div id="submissions-list" class="space-y-4"></div>

    <!-- Loading -->
    <div id="loading" class="text-center py-12">
      <div class="text-6xl mb-4 animate-spin">â³</div>
      <p class="text-gray-300">Memuat data siswa...</p>
    </div>

    <!-- Empty -->
    <div id="empty-state" class="hidden text-center py-12">
      <div class="text-6xl mb-4">ğŸ“­</div>
      <p class="text-gray-300">Belum ada submission dari siswa</p>
    </div>
  </div>

  <!-- Modal Detail -->
  <div id="detail-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 overflow-y-auto p-4">
    <div class="min-h-screen flex items-center justify-center">
      <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-3xl max-w-5xl w-full p-8 relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-4xl hover:text-yellow-400">Ã—</button>
        <div id="modal-content"></div>
      </div>
    </div>
  </div>

  <!-- Modal Edit -->
  <div id="edit-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 overflow-y-auto p-4">
    <div class="min-h-screen flex items-center justify-center">
      <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-3xl max-w-2xl w-full p-8 relative">
        <button onclick="closeEditModal()" class="absolute top-4 right-4 text-4xl hover:text-yellow-400">Ã—</button>
        <h2 class="text-3xl font-bold text-yellow-400 mb-6">âœï¸ Edit Data Siswa</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">Nama Siswa</label>
            <input type="text" id="edit-student-name" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
          
          <div>
            <label class="block text-sm text-gray-400 mb-2">Jawaban Benar</label>
            <input type="number" id="edit-correct" min="0" max="10" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
          
          <div>
            <label class="block text-sm text-gray-400 mb-2">Jawaban Salah</label>
            <input type="number" id="edit-wrong" min="0" max="10" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
          
          <div>
            <label class="block text-sm text-gray-400 mb-2">Total Poin</label>
            <input type="number" id="edit-points" min="0" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
          </div>
          
          <div class="flex gap-3 pt-4">
            <button onclick="saveEdit()" class="flex-1 px-6 py-3 bg-green-500 hover:bg-green-600 rounded-lg font-bold text-white transition-all">
              âœ… Simpan Perubahan
            </button>
            <button onclick="closeEditModal()" class="flex-1 px-6 py-3 bg-gray-500 hover:bg-gray-600 rounded-lg font-bold text-white transition-all">
              âŒ Batal
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const isLoggedIn = sessionStorage.getItem('guru_logged_in');
      
      if (isLoggedIn !== 'true') {
        window.location.replace('login-guru.html');
      }
    })();

    // Cegah akses via back button setelah logout
    window.addEventListener('pageshow', function(event) {
      if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
        if (sessionStorage.getItem('guru_logged_in') !== 'true') {
          window.location.replace('login-guru.html');
        }
      }
    });
    // ===== SUPABASE INITIALIZATION =====
    const SUPABASE_URL = 'https://szvkwvtvqpwzalqnbous.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6dmt3dnR2cXB3emFscW5ib3VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NTIyMDYsImV4cCI6MjA4MjEyODIwNn0.lo6jlTthlrqfPK8hYEQ-nrXTeWnw4fuhocAnW7nskJE';
    
    // Gunakan window.supabaseClient agar tidak bentrok
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('âœ… Supabase initialized');

    // Check login (simplified for demo)
    const username = sessionStorage.getItem('guru_username') || 'Guru Demo';
    document.getElementById('username-display').textContent = username;

    let allSubmissions = [];

    // Logout
    // Logout
function logout() {
  // Hapus semua session
  sessionStorage.clear();
  
  // Redirect ke login (jangan pakai reload!)
  window.location.replace('login-guru.html');
  
  // Backup: kalau replace gagal
  window.location.href = 'login-guru.html';
}

    // Load submissions from Supabase
    async function loadSubmissions() {
      console.log('ğŸ”„ Starting to load submissions...');
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('empty-state').classList.add('hidden');
      document.getElementById('submissions-list').innerHTML = '';

      try {
        console.log('ğŸ“¡ Connecting to Supabase...');
        console.log('URL:', SUPABASE_URL);
        
        const { data, error } = await supabaseClient
          .from('submissions')
          .select('*')
          .order('created_at', { ascending: false });
        
        console.log('ğŸ“¦ Response data:', data);
        console.log('âŒ Response error:', error);
        
        if (error) {
          console.error('ğŸš¨ Supabase Error Details:', {
            message: error.message,
            details: error.details,
            hint: error.hint,
            code: error.code
          });
          throw error;
        }
        
        allSubmissions = data || [];
        console.log('âœ… Successfully loaded submissions:', allSubmissions.length);
        console.log('ğŸ“Š Sample data:', allSubmissions[0]);

        applyFilters();
        updateStats();
        
        document.getElementById('loading').classList.add('hidden');

        if (allSubmissions.length === 0) {
          document.getElementById('empty-state').classList.remove('hidden');
        }

      } catch (error) {
        console.error('âŒ Error loading submissions:', error);
        console.error('ğŸ“‹ Error stack:', error.stack);
        
        document.getElementById('loading').innerHTML = `
          <div class="text-red-400 text-center">
            <div class="text-6xl mb-4">âŒ</div>
            <p class="text-xl font-bold mb-2">Gagal memuat data</p>
            <p class="text-sm mb-2">${error.message}</p>
            <div class="bg-white/10 rounded-lg p-4 mt-4 text-left text-xs max-w-2xl mx-auto">
              <p class="font-bold mb-2">ğŸ” Detail Error:</p>
              <pre class="text-gray-300 overflow-auto">${JSON.stringify(error, null, 2)}</pre>
            </div>
            <button onclick="loadSubmissions()" class="mt-4 px-6 py-2 bg-yellow-500 hover:bg-yellow-600 rounded-lg text-gray-900 font-bold">
              ğŸ”„ Coba Lagi
            </button>
            <div class="mt-4 text-xs text-gray-400">
              <p>ğŸ’¡ Tips: Buka Console (F12) untuk melihat detail lengkap</p>
            </div>
          </div>
        `;
      }
    }

    // Apply filters
    function applyFilters() {
      const nameFilter = document.getElementById('filter-name').value.toLowerCase();
      const skillFilter = document.getElementById('filter-skill').value;
      const missionFilter = document.getElementById('filter-mission').value;

      const filtered = allSubmissions.filter(sub => {
        const matchName = !nameFilter || sub.student_name.toLowerCase().includes(nameFilter);
        const matchSkill = !skillFilter || sub.skill === skillFilter;
        const matchMission = !missionFilter || sub.mission === missionFilter;
        return matchName && matchSkill && matchMission;
      });

      renderSubmissions(filtered);
    }

    // Update stats
    function updateStats() {
      const total = allSubmissions.length;
      const avgCorrect = total > 0 ? (allSubmissions.reduce((sum, s) => sum + (s.correct_count || 0), 0) / total).toFixed(1) : 0;
      const avgPoints = total > 0 ? Math.round(allSubmissions.reduce((sum, s) => sum + (s.total_points || 0), 0) / total) : 0;
      const avgPercentage = total > 0 ? (allSubmissions.reduce((sum, s) => sum + (s.percentage || 0), 0) / total).toFixed(1) : 0;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-avg-correct').textContent = avgCorrect;
      document.getElementById('stat-avg-points').textContent = avgPoints;
      document.getElementById('stat-avg-percentage').textContent = avgPercentage + '%';
    }

    // Render submissions
    function renderSubmissions(submissions) {
      const listEl = document.getElementById('submissions-list');
      
      if (submissions.length === 0) {
        listEl.innerHTML = '<div class="text-center py-8 text-gray-400">Tidak ada data yang cocok dengan filter</div>';
        return;
      }

      listEl.innerHTML = submissions.map(sub => `
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 hover:bg-white/15 transition-all">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4 cursor-pointer flex-1" onclick="showDetail(${sub.id})">
              <div class="text-5xl">${getRankIcon(sub.rank)}</div>
              <div>
                <h3 class="text-2xl font-bold text-yellow-400">${sub.student_name}</h3>
                <p class="text-gray-400">${sub.skill_name} â€¢ ${sub.mission_name}</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-3xl font-bold text-green-400">${(sub.percentage || 0).toFixed(1)}%</p>
              <p class="text-sm text-gray-400">${sub.rank || 'N/A'}</p>
            </div>
          </div>
          
          <div class="grid grid-cols-4 gap-4 text-center mb-4">
            <div class="bg-green-500/20 rounded-lg p-3">
              <p class="text-2xl font-bold text-green-400">${sub.correct_count || 0}</p>
              <p class="text-xs text-gray-400">Benar</p>
            </div>
            <div class="bg-red-500/20 rounded-lg p-3">
              <p class="text-2xl font-bold text-red-400">${sub.wrong_count || 0}</p>
              <p class="text-xs text-gray-400">Salah</p>
            </div>
            <div class="bg-yellow-500/20 rounded-lg p-3">
              <p class="text-2xl font-bold text-yellow-400">${sub.total_points || 0}</p>
              <p class="text-xs text-gray-400">Poin</p>
            </div>
            <div class="bg-blue-500/20 rounded-lg p-3">
              <p class="text-2xl font-bold text-blue-400">${sub.total_questions || 10}</p>
              <p class="text-xs text-gray-400">Soal</p>
            </div>
          </div>
          
          <div class="border-t border-white/10 pt-4 space-y-3">
  <!-- Tanggal di atas (full width) -->
  <div class="text-sm text-gray-400">
    ğŸ“… ${formatDate(sub.created_at)}
  </div>
  
  <!-- Buttons dengan layout responsif -->
  <div class="grid grid-cols-3 gap-2">
    <button onclick="showDetail(${sub.id})" class="px-2 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-xs font-bold transition-all flex flex-col items-center gap-1">
      <span class="text-lg">ğŸ‘ï¸</span>
      <span>Detail</span>
    </button>
    <button onclick="editSubmission(${sub.id})" class="px-2 py-2 bg-yellow-500 hover:bg-yellow-600 rounded-lg text-xs font-bold text-gray-900 transition-all flex flex-col items-center gap-1">
      <span class="text-lg">âœï¸</span>
      <span>Edit</span>
    </button>
    <button onclick="deleteSubmission(${sub.id}, '${sub.student_name}')" class="px-2 py-2 bg-red-500 hover:bg-red-600 rounded-lg text-xs font-bold transition-all flex flex-col items-center gap-1">
      <span class="text-lg">ğŸ—‘ï¸</span>
      <span>Hapus</span>
    </button>
  </div>
</div>
        </div>
      `).join('');
    }

    // Helper: Get rank icon
    function getRankIcon(rank) {
      if (rank === 'Legenda') return 'ğŸ‘‘';
      if (rank === 'Pahlawan') return 'ğŸ¦¸';
      if (rank === 'Ksatria') return 'âš”ï¸';
      return 'ğŸŒ±';
    }

    // Helper: Format date
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('id-ID', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Show detail modal
    function showDetail(submissionId) {
      const sub = allSubmissions.find(s => s.id === submissionId);
      if (!sub) return;

      const modal = document.getElementById('detail-modal');
      const content = document.getElementById('modal-content');

      const answers = Array.isArray(sub.answers) ? sub.answers : [];

      content.innerHTML = `
        <h2 class="text-3xl font-bold text-yellow-400 mb-4">ğŸ“‹ Detail Pengerjaan: ${sub.student_name}</h2>
        
        <div class="bg-white/10 rounded-xl p-4 mb-6">
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div><span class="text-gray-400">Jurus:</span> <span class="font-bold">${sub.skill_name}</span></div>
            <div><span class="text-gray-400">Misi:</span> <span class="font-bold">${sub.mission_name}</span></div>
            <div><span class="text-gray-400">Rank:</span> <span class="font-bold">${sub.rank}</span></div>
            <div><span class="text-gray-400">Tanggal:</span> <span class="font-bold">${formatDate(sub.created_at)}</span></div>
          </div>
        </div>

        <h3 class="text-xl font-bold mb-4">ğŸ“ Jawaban Per Soal (${answers.length} soal):</h3>
        
        <div class="space-y-4 max-h-[500px] overflow-y-auto">
          ${answers.length > 0 ? answers.map((ans, idx) => `
            <div class="bg-white/5 rounded-xl p-4 ${ans.is_correct ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'}">
              <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                  <p class="font-bold text-lg mb-1">${ans.question_title || 'Soal ' + (idx + 1)}</p>
                  <p class="text-sm text-gray-400 mb-2">${ans.question_story || ''}</p>
                  <p class="text-yellow-400 mb-2">â“ ${ans.question_text || 'N/A'}</p>
                </div>
                <div class="text-right ml-4">
                  <span class="text-3xl">${ans.is_correct ? 'âœ…' : 'âŒ'}</span>
                  <p class="text-xs text-gray-400 mt-1">${ans.time_spent_seconds || 0}s</p>
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-2 mb-2 text-sm">
                <div class="bg-blue-500/20 rounded p-2">
                  <span class="text-gray-400">Jawaban:</span>
                  <span class="font-bold ${ans.is_correct ? 'text-green-400' : 'text-red-400'}">${ans.selected_answer || 'Tidak dijawab'}</span>
                </div>
                <div class="bg-green-500/20 rounded p-2">
                  <span class="text-gray-400">Benar:</span>
                  <span class="font-bold text-green-400">${ans.correct_answer || 'N/A'}</span>
                </div>
              </div>
              
              ${ans.photo_url ? `
                <div class="mt-3">
                  <p class="text-sm text-gray-400 mb-2">ğŸ“· Foto Pengerjaan:</p>
                  <a href="${ans.photo_url}" target="_blank" class="block">
                    <img src="${ans.photo_url}" 
                         alt="Foto Soal ${ans.question_number}" 
                         class="w-full max-w-md rounded-lg border-2 border-yellow-500/50 hover:border-yellow-500 transition-all cursor-pointer"
                         onerror="this.parentElement.innerHTML='<div class=\\'bg-red-500/20 rounded p-4 text-red-300 text-sm\\'>âŒ Foto tidak dapat dimuat</div>'">
                  </a>
                  <a href="${ans.photo_url}" target="_blank" class="text-xs text-cyan-400 hover:text-cyan-300 mt-1 inline-block">
                    ğŸ”— Buka Foto di Tab Baru
                  </a>
                </div>
              ` : '<p class="text-sm text-gray-500 italic mt-2">ğŸ“· Tidak ada foto</p>'}
            </div>
          `).join('') : '<p class="text-center text-gray-400 py-8">Tidak ada data jawaban</p>'}
        </div>
      `;

      modal.classList.remove('hidden');
    }

    // Close modal
    function closeModal() {
      document.getElementById('detail-modal').classList.add('hidden');
    }

    // Edit submission
    let editingSubmissionId = null;

    function editSubmission(submissionId) {
      const sub = allSubmissions.find(s => s.id === submissionId);
      if (!sub) return;

      editingSubmissionId = submissionId;

      document.getElementById('edit-student-name').value = sub.student_name || '';
      document.getElementById('edit-correct').value = sub.correct_count || 0;
      document.getElementById('edit-wrong').value = sub.wrong_count || 0;
      document.getElementById('edit-points').value = sub.total_points || 0;

      document.getElementById('edit-modal').classList.remove('hidden');
    }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.add('hidden');
      editingSubmissionId = null;
    }

    async function saveEdit() {
      if (!editingSubmissionId) return;

      const studentName = document.getElementById('edit-student-name').value.trim();
      const correct = parseInt(document.getElementById('edit-correct').value) || 0;
      const wrong = parseInt(document.getElementById('edit-wrong').value) || 0;
      const points = parseInt(document.getElementById('edit-points').value) || 0;

      if (!studentName) {
        alert('âŒ Nama siswa tidak boleh kosong!');
        return;
      }

      if (correct + wrong > 10) {
        alert('âŒ Total benar + salah tidak boleh lebih dari 10!');
        return;
      }

      try {
        const percentage = (correct / 10) * 100;
        let rank = 'Petualang';
        if (percentage >= 90) rank = 'Legenda';
        else if (percentage >= 70) rank = 'Pahlawan';
        else if (percentage >= 50) rank = 'Ksatria';

        const { data, error } = await supabaseClient
          .from('submissions')
          .update({
            student_name: studentName,
            correct_count: correct,
            wrong_count: wrong,
            total_points: points,
            percentage: percentage,
            rank: rank
          })
          .eq('id', editingSubmissionId)
          .select();

        if (error) throw error;

        console.log('âœ… Update berhasil:', data);
        alert('âœ… Data berhasil diupdate!');
        
        closeEditModal();
        loadSubmissions();

      } catch (error) {
        console.error('âŒ Error updating:', error);
        alert('âŒ Gagal update data: ' + error.message);
      }
    }

    // Delete submission
    async function deleteSubmission(submissionId, studentName) {
      const confirmDelete = confirm(`ğŸ—‘ï¸ Yakin ingin menghapus data "${studentName}"?\n\nData yang dihapus tidak dapat dikembalikan!`);
      
      if (!confirmDelete) return;

      try {
        const { error } = await supabaseClient
          .from('submissions')
          .delete()
          .eq('id', submissionId);

        if (error) throw error;

        console.log('âœ… Delete berhasil');
        alert('âœ… Data berhasil dihapus!');
        
        loadSubmissions();

      } catch (error) {
        console.error('âŒ Error deleting:', error);
        alert('âŒ Gagal hapus data: ' + error.message);
      }
    }

    // Event listeners
    document.getElementById('filter-name').addEventListener('input', applyFilters);
    document.getElementById('filter-skill').addEventListener('change', applyFilters);
    document.getElementById('filter-mission').addEventListener('change', applyFilters);

    // Init - Load data on page load
    loadSubmissions();
  </script>
</body>
</html>